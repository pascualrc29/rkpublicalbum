<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guestbook Admin - Rodger & Katherine</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    screens: {
                        'xs': '380px', // Custom breakpoint for very small phones
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .progress-bar-striped {
            background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
            background-size: 1rem 1rem;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        window.FirebaseLib = {
            initializeApp,
            getAuth,
            signInWithPopup,
            GoogleAuthProvider,
            signOut,
            onAuthStateChanged,
            getFirestore,
            collection,
            onSnapshot,
            doc,
            updateDoc,
            deleteDoc
        };
        window.dispatchEvent(new Event('firebase-loaded'));
    </script>

    <!-- Admin Application Logic -->
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Inline Icons ---
        const ShieldIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></svg>
        );
        const LogoutIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
        );
        const ImageIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
        );
        const LoaderIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
        );
        const EyeIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
        );
        const EyeOffIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7c.44 0 .87-.03 1.28-.08"/><line x1="2" x2="22" y1="2" y2="22"/></svg>
        );
        const TrashIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
        );
        const DatabaseIcon = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
        );

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAzXa4t38EBf0M1XHjjZYKvW3xFm4dpOgs",
            authDomain: "wedding-guestbook-2e65f.firebaseapp.com",
            projectId: "wedding-guestbook-2e65f",
            storageBucket: "wedding-guestbook-2e65f.firebasestorage.app",
            messagingSenderId: "68755215964",
            appId: "1:68755215964:web:1863354acd118b478d7899"
        };

        // --- Helper: Calculate Size ---
        const formatBytes = (bytes, decimals = 2) => {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        };

        const AdminApp = () => {
            const [user, setUser] = useState(null);
            const [photos, setPhotos] = useState([]);
            const [loading, setLoading] = useState(true);
            const [firebaseReady, setFirebaseReady] = useState(false);
            const [auth, setAuth] = useState(null);
            const [db, setDb] = useState(null);
            const [errorMsg, setErrorMsg] = useState('');
            
            // Storage Settings
            const [storagePlan, setStoragePlan] = useState('spark'); // 'spark' or 'blaze'
            const SPARK_LIMIT = 1024 * 1024 * 1024; // 1 GB
            const BLAZE_LIMIT = 1024 * 1024 * 1024 * 5; // 5 GB

            // Initialize Firebase
            useEffect(() => {
                const init = () => {
                    if (window.FirebaseLib) {
                        const { initializeApp, getAuth, getFirestore } = window.FirebaseLib;
                        const app = initializeApp(firebaseConfig);
                        setAuth(getAuth(app));
                        setDb(getFirestore(app));
                        setFirebaseReady(true);
                    }
                };

                if (window.FirebaseLib) {
                    init();
                } else {
                    window.addEventListener('firebase-loaded', init);
                    return () => window.removeEventListener('firebase-loaded', init);
                }
            }, []);

            // Auth Listener
            useEffect(() => {
                if (!firebaseReady || !auth) return;
                const { onAuthStateChanged } = window.FirebaseLib;
                
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    if (!currentUser) setLoading(false);
                });
                return () => unsubscribe();
            }, [firebaseReady, auth]);

            // Data Listener
            useEffect(() => {
                if (!user || !db) return;
                const { collection, onSnapshot } = window.FirebaseLib;
                
                const q = collection(db, 'guestbook_photos');
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const fetchedPhotos = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    fetchedPhotos.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    setPhotos(fetchedPhotos);
                    setLoading(false);
                }, (error) => {
                    console.error("Data fetch error:", error);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [user, db]);

            // --- Calculation Logic ---
            const storageStats = useMemo(() => {
                let totalBytes = 0;
                photos.forEach(photo => {
                    if (photo.imageUrl) totalBytes += photo.imageUrl.length;
                    if (photo.caption) totalBytes += photo.caption.length;
                    totalBytes += 100; 
                });

                const limit = storagePlan === 'spark' ? SPARK_LIMIT : BLAZE_LIMIT;
                const percentage = Math.min(100, (totalBytes / limit) * 100);
                
                let colorClass = "bg-blue-500";
                if (percentage > 75) colorClass = "bg-yellow-500";
                if (percentage > 90) colorClass = "bg-red-500";

                return {
                    usedBytes: totalBytes,
                    limitBytes: limit,
                    formattedUsed: formatBytes(totalBytes),
                    formattedLimit: formatBytes(limit),
                    percentage: percentage.toFixed(1),
                    colorClass
                };
            }, [photos, storagePlan]);

            // --- Actions ---

            const handleLogin = async () => {
                setErrorMsg('');
                const { signInWithPopup, GoogleAuthProvider } = window.FirebaseLib;
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Login failed", error);
                    setErrorMsg(error.message);
                }
            };

            const handleLogout = async () => {
                const { signOut } = window.FirebaseLib;
                await signOut(auth);
            };

            const toggleVisibility = async (photo) => {
                const { doc, updateDoc } = window.FirebaseLib;
                const photoRef = doc(db, "guestbook_photos", photo.id);
                try {
                    await updateDoc(photoRef, { isHidden: !photo.isHidden });
                } catch (error) {
                    alert("Failed to update status.");
                }
            };

            const deletePhoto = async (id) => {
                if (!confirm("Permanently delete this photo?")) return;
                const { doc, deleteDoc } = window.FirebaseLib;
                const photoRef = doc(db, "guestbook_photos", id);
                try {
                    await deleteDoc(photoRef);
                } catch (error) {
                    alert("Failed to delete.");
                }
            };

            // --- Render ---

            if (!firebaseReady) return <div className="min-h-screen flex items-center justify-center text-slate-400">Loading App...</div>;

            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                        <div className="bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full text-center">
                            <div className="w-16 h-16 bg-rose-100 text-rose-500 rounded-full flex items-center justify-center mx-auto mb-6">
                                <ShieldIcon className="w-8 h-8" />
                            </div>
                            <h1 className="text-2xl font-bold text-slate-800 mb-2">Admin Access</h1>
                            <p className="text-slate-500 mb-8">Rodger & Katherine's Guestbook</p>
                            
                            <button onClick={handleLogin} className="w-full bg-slate-900 text-white py-3 rounded-lg font-medium hover:bg-slate-800 transition-colors flex items-center justify-center gap-2 mb-4">
                                <img src="https://www.svgrepo.com/show/475656/google-color.svg" className="w-5 h-5" alt="G" />
                                Sign in with Google
                            </button>
                            {errorMsg && <div className="bg-red-50 text-red-600 text-xs p-3 rounded-lg border border-red-200">{errorMsg}</div>}
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-100 pb-12">
                    {/* Header: Improved for Mobile Visibility */}
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-50 px-4 py-3 flex justify-between items-center shadow-sm">
                        <div className="flex items-center gap-3">
                            <div className="w-9 h-9 bg-rose-500 text-white rounded-lg flex items-center justify-center font-bold text-sm shadow-sm">RK</div>
                            <div>
                                <h1 className="font-bold text-slate-800 text-sm sm:text-base">Admin Dashboard</h1>
                            </div>
                        </div>
                        
                        {/* Sign Out Button: More prominent, visible on mobile */}
                        <button 
                            onClick={handleLogout} 
                            className="flex items-center gap-2 px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg transition-colors border border-slate-200 shadow-sm active:scale-95"
                        >
                            <span className="text-xs font-semibold hidden xs:inline-block">Sign Out</span>
                            <LogoutIcon className="w-4 h-4" />
                        </button>
                    </header>

                    <main className="p-4 sm:p-6 max-w-7xl mx-auto space-y-6">
                        
                        {/* Storage Widget */}
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                            <div className="flex justify-between items-start mb-4">
                                <div className="flex items-center gap-2">
                                    <div className="p-2 bg-blue-50 text-blue-500 rounded-lg">
                                        <DatabaseIcon className="w-5 h-5" />
                                    </div>
                                    <div>
                                        <h2 className="font-semibold text-slate-800 text-sm sm:text-base">Storage Usage</h2>
                                        <p className="text-[10px] sm:text-xs text-slate-500">Estimated consumption</p>
                                    </div>
                                </div>
                                
                                <select 
                                    value={storagePlan} 
                                    onChange={(e) => setStoragePlan(e.target.value)}
                                    className="text-xs border border-slate-200 rounded-md px-2 py-1 bg-slate-50 text-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-100"
                                >
                                    <option value="spark">Plan: Spark (Free)</option>
                                    <option value="blaze">Plan: Blaze (Pay)</option>
                                </select>
                            </div>

                            <div className="relative pt-1">
                                <div className="flex mb-2 items-center justify-between">
                                    <div>
                                        <span className="text-xs font-semibold inline-block text-slate-600">
                                            {storageStats.formattedUsed} used
                                        </span>
                                    </div>
                                    <div className="text-right">
                                        <span className="text-xs font-semibold inline-block text-slate-600">
                                            {storageStats.formattedLimit} limit
                                        </span>
                                    </div>
                                </div>
                                <div className="overflow-hidden h-3 mb-4 text-xs flex rounded-full bg-slate-100 border border-slate-100">
                                    <div 
                                        style={{ width: `${storageStats.percentage}%` }} 
                                        className={`shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center transition-all duration-500 ${storageStats.colorClass} progress-bar-striped`}
                                    ></div>
                                </div>
                                <div className="flex justify-between text-xs text-slate-400">
                                    <span>{storageStats.percentage}% Consumed</span>
                                    <span>{photos.length} Photos total</span>
                                </div>
                            </div>
                        </div>

                        {/* Photo Grid */}
                        {loading ? (
                            <div className="flex items-center justify-center py-20 text-slate-400">
                                <LoaderIcon className="w-8 h-8 animate-spin" />
                            </div>
                        ) : photos.length === 0 ? (
                            <div className="text-center py-20 text-slate-400">
                                <ImageIcon className="w-12 h-12 mx-auto mb-4 opacity-50" />
                                <p>No photos uploaded yet.</p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                                {photos.map((photo) => (
                                    <div 
                                        key={photo.id} 
                                        className={`group relative bg-white rounded-xl overflow-hidden card-shadow transition-all hover:ring-2 hover:ring-rose-500 ${photo.isHidden ? 'ring-2 ring-red-500 opacity-75' : ''}`}
                                    >
                                        <div className="aspect-square bg-slate-200 relative">
                                            <img 
                                                src={photo.imageUrl} 
                                                alt="Guest upload" 
                                                className="w-full h-full object-cover"
                                                loading="lazy"
                                            />
                                            {photo.isHidden && (
                                                <div className="absolute inset-0 bg-red-500/20 flex items-center justify-center backdrop-blur-[1px]">
                                                    <span className="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded shadow">HIDDEN</span>
                                                </div>
                                            )}
                                        </div>
                                        <div className="p-3">
                                            <p className="text-xs text-slate-400 mb-1">
                                                {new Date(photo.timestamp).toLocaleString()}
                                            </p>
                                            <p className="text-sm text-slate-800 font-medium truncate h-5">
                                                {photo.caption || <span className="text-slate-300 italic">No caption</span>}
                                            </p>
                                        </div>
                                        {/* Action Buttons: Enhanced for Touch */}
                                        <div className="absolute top-2 right-2 flex flex-col gap-2">
                                            <button 
                                                onClick={() => toggleVisibility(photo)}
                                                className={`p-2.5 rounded-full shadow-md text-white transition-transform active:scale-95 ${photo.isHidden ? 'bg-green-500 hover:bg-green-600' : 'bg-slate-800 hover:bg-slate-900'}`}
                                            >
                                                {photo.isHidden ? <EyeIcon className="w-4 h-4" /> : <EyeOffIcon className="w-4 h-4" />}
                                            </button>
                                            <button 
                                                onClick={() => deletePhoto(photo.id)}
                                                className="bg-red-500 hover:bg-red-600 text-white p-2.5 rounded-full shadow-md transition-transform active:scale-95"
                                            >
                                                <TrashIcon className="w-4 h-4" />
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AdminApp />);
    </script>
</body>
</html>
