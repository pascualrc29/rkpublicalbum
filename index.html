<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rodger & Katherine - Guestbook 2026</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    screens: { 'xs': '400px' },
                    padding: { 'safe': 'env(safe-area-inset-bottom)' }
                }
            }
        }
    </script>
    
    <!-- 2. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f5f5f4; margin: 0; padding: 0; }
        .font-serif { font-family: 'Playfair Display', serif; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .animate-spin { animation: spin 1s linear infinite; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .min-h-screen-ios { min-height: 100vh; min-height: -webkit-fill-available; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- 5. Firebase Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        window.FirebaseLib = {
            initializeApp,
            getAuth,
            signInAnonymously,
            onAuthStateChanged,
            getFirestore,
            collection,
            addDoc,
            onSnapshot
        };
        window.dispatchEvent(new Event('firebase-loaded'));
    </script>

    <!-- 6. Application Logic -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- Icons ---
        const CameraIcon = ({ size = 24, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>);
        const UploadIcon = ({ size = 24, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>);
        const XIcon = ({ size = 24, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>);
        const HouseIcon = ({ size = 24, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>);
        const GridIcon = ({ size = 24, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>);
        const ChevronLeftIcon = ({ size = 24, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="15 18 9 12 15 6"/></svg>);
        const ChevronRightIcon = ({ size = 24, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="9 18 15 12 9 6"/></svg>);
        const ImageIcon = ({ size = 24, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>);
        const Loader2Icon = ({ size = 24, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>);
        const PlusIcon = ({ size = 24, className = "" }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>);

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAzXa4t38EBf0M1XHjjZYKvW3xFm4dpOgs",
            authDomain: "wedding-guestbook-2e65f.firebaseapp.com",
            projectId: "wedding-guestbook-2e65f",
            storageBucket: "wedding-guestbook-2e65f.firebasestorage.app",
            messagingSenderId: "68755215964",
            appId: "1:68755215964:web:1863354acd118b478d7899"
        };

        // --- OPTIMIZED Image Compression ---
        // INCREASED QUALITY: 1024px at 0.8 is great for Social Media
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 1024; // Increased from 800 to 1024 (Sharper)
                        const MAX_HEIGHT = 1024;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        // Increased Quality from 0.6 to 0.8 (Better colors/details)
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        };

        // --- Progressive Image Loader ---
        const ImageWithLoader = ({ src, alt, className, onClick }) => {
            const [loaded, setLoaded] = useState(false);
            return (
                <div 
                    className={`relative overflow-hidden bg-stone-200 ${className}`} 
                    onClick={onClick}
                >
                    {!loaded && (
                        <div className="absolute inset-0 flex items-center justify-center text-stone-400">
                            <Loader2Icon size={20} className="animate-spin" />
                        </div>
                    )}
                    <img 
                        src={src} 
                        alt={alt} 
                        className={`w-full h-full object-cover transition-opacity duration-500 ${loaded ? 'opacity-100' : 'opacity-0'}`}
                        onLoad={() => setLoaded(true)}
                        loading="lazy"
                    />
                </div>
            );
        };

        // --- Components ---

        const Navigation = ({ setView, view }) => (
            <nav className="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-stone-200 px-6 py-3 pb-6 flex justify-around items-center z-50 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
                <button 
                    onClick={() => setView('home')}
                    className={`flex flex-col items-center gap-1.5 p-2 rounded-lg transition-colors ${view === 'home' ? 'text-rose-500' : 'text-stone-400 hover:text-stone-600'}`}
                >
                    <HouseIcon size={26} />
                    <span className="text-[10px] uppercase tracking-widest font-bold">Home</span>
                </button>
                
                <div className="relative -top-6">
                    <button 
                        onClick={() => setView('upload')}
                        className="bg-rose-500 text-white p-5 rounded-full shadow-xl shadow-rose-200 active:scale-95 transition-transform border-[6px] border-stone-50 hover:bg-rose-600"
                    >
                        <PlusIcon size={32} />
                    </button>
                </div>

                <button 
                    onClick={() => setView('gallery')}
                    className={`flex flex-col items-center gap-1.5 p-2 rounded-lg transition-colors ${view === 'gallery' ? 'text-rose-500' : 'text-stone-400 hover:text-stone-600'}`}
                >
                    <GridIcon size={26} />
                    <span className="text-[10px] uppercase tracking-widest font-bold">Gallery</span>
                </button>
            </nav>
        );

        const LandingPage = ({ photos, setView }) => {
            const previewPhotos = photos.slice(0, 12);
            return (
                <div className="pb-36 animate-fade-in w-full flex flex-col items-center">
                    <div className="w-full text-center py-12 px-6 bg-stone-50 border-b border-stone-100 flex flex-col items-center justify-center min-h-[35vh]">
                        <h1 className="font-serif text-5xl md:text-7xl text-stone-800 mb-4">Rodger & Katherine</h1>
                        <p className="text-rose-500 tracking-[0.1em] text-sm md:text-base font-bold uppercase mb-8">Join us, as we celebrate this unforgettable moment.</p>
                        <p className="text-stone-500 text-base md:text-lg max-w-lg mx-auto leading-relaxed">
                            We can't be everywhere at once, but you are! Help us capture the magic we might miss. Snap your favorite moments, candid smiles, and dance floor moves, and upload them here to complete our story.
                        </p>
                    </div>

                    <div className="w-full max-w-7xl px-4 md:px-8 mt-12">
                        <div className="flex justify-between items-end mb-6">
                            <h2 className="font-serif text-2xl md:text-3xl text-stone-800">Live Moments</h2>
                            <button 
                                onClick={() => setView('gallery')}
                                className="text-rose-500 text-sm font-bold uppercase tracking-wider hover:text-rose-600"
                            >
                                View All ({photos.length})
                            </button>
                        </div>
                        
                        {photos.length === 0 ? (
                            <div className="w-full aspect-[3/1] bg-stone-100 rounded-2xl border-2 border-dashed border-stone-200 flex flex-col items-center justify-center text-stone-400">
                                <ImageIcon size={48} className="mb-4 opacity-50" />
                                <span className="text-lg">No photos yet. Be the first!</span>
                            </div>
                        ) : (
                            <div className="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 gap-3 md:gap-4">
                                {previewPhotos.map((photo) => (
                                    <div key={photo.id} className="aspect-square relative group overflow-hidden rounded-xl shadow-sm transition-transform hover:-translate-y-1">
                                        <ImageWithLoader src={photo.imageUrl} alt="Guest upload" className="w-full h-full" />
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    
                    <div className="mt-16 text-center flex flex-col gap-2 pb-8">
                        <p className="font-serif italic text-stone-400 text-lg">#KathRodtoforever</p>
                        <p className="font-serif italic text-stone-400 text-lg">#RodgerthatcopyKath</p>
                        <br />
                        <a href="admin.html" className="text-[10px] text-stone-300 hover:text-stone-400 transition-colors uppercase tracking-widest mt-8">Admin Access</a>
                    </div>
                </div>
            );
        };

        const UploadPage = ({ setView, user, db }) => {
            const [files, setFiles] = useState([]);
            const [previews, setPreviews] = useState([]);
            const [caption, setCaption] = useState('');
            const [uploading, setUploading] = useState(false);
            const [progress, setProgress] = useState(0);
            
            const cameraInputRef = useRef(null);
            const galleryInputRef = useRef(null);

            const handleFileSelect = (e) => {
                const selectedFiles = Array.from(e.target.files);
                if (selectedFiles.length > 0) {
                    const newPreviews = selectedFiles.map(file => URL.createObjectURL(file));
                    setFiles(prev => [...prev, ...selectedFiles]);
                    setPreviews(prev => [...prev, ...newPreviews]);
                }
            };

            const removePhoto = (index) => {
                setFiles(prev => prev.filter((_, i) => i !== index));
                setPreviews(prev => prev.filter((_, i) => i !== index));
            };

            const handleSubmit = async () => {
                if (files.length === 0 || !user) return;
                setUploading(true);
                setProgress(0);

                try {
                    const { addDoc, collection } = window.FirebaseLib;
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        const compressedBase64 = await compressImage(file);
                        await addDoc(collection(db, 'guestbook_photos'), {
                            imageUrl: compressedBase64,
                            caption: caption,
                            uploadedBy: user.uid,
                            timestamp: Date.now(),
                            type: 'photo',
                            batchId: Date.now().toString()
                        });
                        setProgress(i + 1);
                    }
                    setView('gallery');
                } catch (error) {
                    console.error("Error uploading:", error);
                    alert("Upload failed. Please try again.");
                } finally {
                    setUploading(false);
                }
            };

            return (
                <div className="min-h-screen-ios w-full bg-stone-50 flex flex-col animate-fade-in z-50 relative pb-28">
                    <div className="p-4 flex items-center justify-between bg-white border-b border-stone-100 shadow-sm sticky top-0 z-10">
                        <button onClick={() => setView('home')} className="text-stone-500 hover:text-stone-800">
                            <XIcon size={28} />
                        </button>
                        <h2 className="font-serif text-xl text-stone-800">Add Memories</h2>
                        <div className="w-7" /> 
                    </div>

                    <div className="flex-1 w-full max-w-3xl mx-auto p-6 flex flex-col">
                        
                        {files.length === 0 ? (
                            <div className="flex flex-col gap-6 mt-12 w-full max-w-md mx-auto">
                                <div 
                                    onClick={() => cameraInputRef.current?.click()}
                                    className="bg-white border-2 border-dashed border-stone-300 rounded-3xl p-10 flex flex-col items-center justify-center gap-6 cursor-pointer hover:bg-rose-50 hover:border-rose-200 transition-all shadow-sm group"
                                >
                                    <div className="w-20 h-20 rounded-full bg-rose-50 group-hover:bg-rose-100 flex items-center justify-center text-rose-500 transition-colors">
                                        <CameraIcon size={40} />
                                    </div>
                                    <div className="text-center">
                                        <p className="text-stone-800 font-medium text-xl mb-1">Take a Photo</p>
                                        <p className="text-stone-400">Use your camera directly</p>
                                    </div>
                                </div>

                                <div 
                                    onClick={() => galleryInputRef.current?.click()}
                                    className="bg-white border-2 border-dashed border-stone-300 rounded-3xl p-10 flex flex-col items-center justify-center gap-6 cursor-pointer hover:bg-stone-50 hover:border-stone-400 transition-all shadow-sm group"
                                >
                                    <div className="w-20 h-20 rounded-full bg-stone-100 group-hover:bg-stone-200 flex items-center justify-center text-stone-500 transition-colors">
                                        <UploadIcon size={40} />
                                    </div>
                                    <div className="text-center">
                                        <p className="text-stone-800 font-medium text-xl mb-1">Upload from Gallery</p>
                                        <p className="text-stone-400">Select multiple photos</p>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="flex flex-col gap-8 w-full">
                                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                                    {previews.map((src, index) => (
                                        <div key={index} className="relative aspect-square rounded-2xl overflow-hidden shadow-md border border-stone-200 bg-white">
                                            <img src={src} className="w-full h-full object-cover" alt="preview" />
                                            <button 
                                                onClick={() => removePhoto(index)}
                                                className="absolute top-2 right-2 bg-black/60 text-white p-2 rounded-full hover:bg-red-500 transition-colors backdrop-blur-sm"
                                            >
                                                <XIcon size={16} />
                                            </button>
                                        </div>
                                    ))}
                                    <div 
                                        onClick={() => galleryInputRef.current?.click()}
                                        className="aspect-square rounded-2xl border-2 border-dashed border-stone-300 flex flex-col items-center justify-center gap-2 text-stone-400 cursor-pointer hover:bg-stone-50 transition-colors"
                                    >
                                        <PlusIcon size={32} />
                                        <span className="text-sm font-medium">Add More</span>
                                    </div>
                                </div>

                                <div className="space-y-6 bg-white p-6 rounded-2xl border border-stone-100 shadow-sm max-w-xl mx-auto w-full">
                                    <div className="space-y-2">
                                        <label className="text-xs font-bold text-stone-400 uppercase tracking-wider ml-1">Caption</label>
                                        <input 
                                            type="text" 
                                            placeholder="Write a message for the couple..."
                                            value={caption}
                                            onChange={(e) => setCaption(e.target.value)}
                                            className="w-full bg-stone-50 border border-stone-200 rounded-xl px-4 py-3 text-stone-800 placeholder:text-stone-400 focus:outline-none focus:ring-2 focus:ring-rose-200 transition-all"
                                        />
                                    </div>
                                    
                                    <button 
                                        onClick={handleSubmit}
                                        disabled={uploading}
                                        className="w-full bg-rose-500 text-white py-4 rounded-xl font-medium shadow-lg shadow-rose-200 active:scale-95 transition-all flex items-center justify-center gap-3 text-lg hover:bg-rose-600"
                                    >
                                        {uploading ? (
                                            <>
                                                <Loader2Icon size={24} className="animate-spin" />
                                                <span>Uploading {progress}/{files.length}...</span>
                                            </>
                                        ) : (
                                            <>
                                                <UploadIcon size={24} />
                                                Publish {files.length} {files.length === 1 ? 'Memory' : 'Memories'}
                                            </>
                                        )}
                                    </button>
                                </div>
                            </div>
                        )}

                        <input ref={cameraInputRef} type="file" accept="image/*" capture="environment" className="hidden" onChange={handleFileSelect} />
                        <input ref={galleryInputRef} type="file" accept="image/*" multiple className="hidden" onChange={handleFileSelect} />
                    </div>
                </div>
            );
        };

        const GalleryPage = ({ photos, setView }) => {
            const [selectedIndex, setSelectedIndex] = useState(null);
            const thumbnailRef = useRef(null);
            const [touchStart, setTouchStart] = useState(null);
            const [touchEnd, setTouchEnd] = useState(null);

            // Handle KeyPress Navigation
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (selectedIndex === null) return;
                    if (e.key === 'ArrowRight') handleNext();
                    if (e.key === 'ArrowLeft') handlePrev();
                    if (e.key === 'Escape') setSelectedIndex(null);
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [selectedIndex, photos.length]);

            // Auto-scroll thumbnails when selected index changes
            useEffect(() => {
                if (selectedIndex !== null && thumbnailRef.current) {
                    const thumb = thumbnailRef.current.children[selectedIndex];
                    if (thumb) {
                        thumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                    }
                }
            }, [selectedIndex]);

            const handlePrev = () => {
                setSelectedIndex(prev => (prev > 0 ? prev - 1 : photos.length - 1));
            };

            const handleNext = () => {
                setSelectedIndex(prev => (prev < photos.length - 1 ? prev + 1 : 0));
            };

            // Swipe Logic
            const onTouchStart = (e) => {
                setTouchEnd(null); // Reset
                setTouchStart(e.targetTouches[0].clientX);
            };

            const onTouchMove = (e) => {
                setTouchEnd(e.targetTouches[0].clientX);
            };

            const onTouchEnd = () => {
                if (!touchStart || !touchEnd) return;
                const distance = touchStart - touchEnd;
                const isLeftSwipe = distance > 50;
                const isRightSwipe = distance < -50;

                if (isLeftSwipe) {
                    handleNext();
                }
                if (isRightSwipe) {
                    handlePrev();
                }
            };

            const selectedPhoto = selectedIndex !== null ? photos[selectedIndex] : null;

            return (
                <div className="min-h-screen-ios w-full bg-white pb-36 animate-fade-in">
                    <div className="sticky top-0 bg-white/90 backdrop-blur-md z-40 px-6 py-4 border-b border-stone-100 flex items-center justify-between shadow-sm">
                        <button 
                            onClick={() => setView('home')}
                            className="flex items-center text-rose-500 gap-1 font-medium hover:text-rose-600"
                        >
                            <ChevronLeftIcon size={24} />
                            Back
                        </button>
                        <div className="flex flex-col items-center">
                            <h2 className="font-serif text-xl font-semibold text-stone-800">Guest Album</h2>
                            <span className="text-xs text-stone-500 font-medium uppercase tracking-wider">{photos.length} Memories</span>
                        </div>
                        <div className="w-16" /> 
                    </div>
                    
                    {/* Grid View */}
                    <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-0.5 mt-0.5 w-full">
                        {photos.map((photo, index) => (
                            <div 
                                key={photo.id} 
                                onClick={() => setSelectedIndex(index)}
                                className="aspect-square relative cursor-pointer overflow-hidden bg-stone-100 group"
                            >
                                <ImageWithLoader src={photo.imageUrl} alt={photo.caption} className="w-full h-full" />
                            </div>
                        ))}
                    </div>

                    {photos.length === 0 && (
                        <div className="flex flex-col items-center justify-center py-32 text-stone-400 px-6 text-center w-full">
                            <GridIcon size={64} className="mb-6 opacity-20" />
                            <p className="text-lg">No photos yet.</p>
                            <button 
                                onClick={() => setView('upload')}
                                className="text-rose-500 font-medium mt-3 text-lg hover:underline"
                            >
                                Tap to upload the first one
                            </button>
                        </div>
                    )}

                    {/* Lightbox / Enhanced Gallery View */}
                    {selectedPhoto && (
                        <div className="fixed inset-0 z-[60] bg-black flex flex-col animate-in fade-in duration-200">
                            {/* Top Bar */}
                            <div className="flex items-center justify-between p-4 text-white bg-gradient-to-b from-black/50 to-transparent z-10">
                                <button onClick={() => setSelectedIndex(null)} className="p-2 hover:bg-white/10 rounded-full">
                                    <XIcon size={28} />
                                </button>
                                <span className="font-serif text-sm opacity-90 tracking-wide">
                                    {new Date(selectedPhoto.timestamp).toLocaleTimeString([], { hour: '2-digit', minute:'2-digit' })}
                                </span>
                                <div className="w-12" />
                            </div>

                            {/* Main Image Area with Swipe */}
                            <div 
                                className="flex-1 flex items-center justify-center relative w-full h-full overflow-hidden"
                                onTouchStart={onTouchStart}
                                onTouchMove={onTouchMove}
                                onTouchEnd={onTouchEnd}
                            >
                                {/* Previous Button (Desktop) */}
                                <button 
                                    onClick={(e) => { e.stopPropagation(); handlePrev(); }}
                                    className="hidden md:flex absolute left-4 p-3 bg-black/30 hover:bg-black/50 text-white rounded-full transition-colors z-20"
                                >
                                    <ChevronLeftIcon size={32} />
                                </button>

                                <img 
                                    key={selectedPhoto.id}
                                    src={selectedPhoto.imageUrl} 
                                    alt="Detail" 
                                    className="max-w-full max-h-full object-contain shadow-2xl transition-opacity duration-300"
                                    style={{ maxHeight: 'calc(100vh - 200px)' }} // Leave space for thumbs/caption
                                />

                                {/* Next Button (Desktop) */}
                                <button 
                                    onClick={(e) => { e.stopPropagation(); handleNext(); }}
                                    className="hidden md:flex absolute right-4 p-3 bg-black/30 hover:bg-black/50 text-white rounded-full transition-colors z-20"
                                >
                                    <ChevronRightIcon size={32} />
                                </button>
                            </div>

                            {/* Bottom Area: Caption + Thumbnails */}
                            <div className="bg-gradient-to-t from-black via-black/90 to-transparent pb-6 pt-4 flex flex-col gap-4">
                                {selectedPhoto.caption && (
                                    <p className="text-white text-center font-serif text-lg md:text-xl leading-relaxed max-w-2xl mx-auto px-6">
                                        "{selectedPhoto.caption}"
                                    </p>
                                )}
                                
                                {/* Thumbnail Strip */}
                                <div 
                                    ref={thumbnailRef}
                                    className="flex gap-2 overflow-x-auto px-4 py-2 scrollbar-hide snap-x"
                                >
                                    {photos.map((photo, index) => (
                                        <div 
                                            key={photo.id}
                                            onClick={() => setSelectedIndex(index)}
                                            className={`
                                                relative flex-shrink-0 w-16 h-16 md:w-20 md:h-20 rounded-lg overflow-hidden cursor-pointer border-2 transition-all snap-center
                                                ${index === selectedIndex ? 'border-rose-500 scale-105 z-10' : 'border-transparent opacity-60 hover:opacity-100'}
                                            `}
                                        >
                                            <img src={photo.imageUrl} className="w-full h-full object-cover" />
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('home');
            const [photos, setPhotos] = useState([]);
            const [loading, setLoading] = useState(true);
            const [firebaseReady, setFirebaseReady] = useState(false);
            const [auth, setAuth] = useState(null);
            const [db, setDb] = useState(null);

            useEffect(() => {
                const init = () => {
                    if (window.FirebaseLib) {
                        const { initializeApp, getAuth, getFirestore } = window.FirebaseLib;
                        const app = initializeApp(firebaseConfig);
                        setAuth(getAuth(app));
                        setDb(getFirestore(app));
                        setFirebaseReady(true);
                    }
                };
                if (window.FirebaseLib) {
                    init();
                } else {
                    window.addEventListener('firebase-loaded', init);
                    return () => window.removeEventListener('firebase-loaded', init);
                }
            }, []);

            useEffect(() => {
                if (!firebaseReady || !auth) return;
                const { signInAnonymously, onAuthStateChanged } = window.FirebaseLib;
                signInAnonymously(auth).catch(console.error);
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                });
                return () => unsubscribe();
            }, [firebaseReady, auth]);

            useEffect(() => {
                if (!user || !db) return;
                const { collection, onSnapshot } = window.FirebaseLib;
                const q = collection(db, 'guestbook_photos');
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const fetchedPhotos = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(photo => !photo.isHidden); // Filter out hidden photos

                    fetchedPhotos.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    setPhotos(fetchedPhotos);
                    setLoading(false);
                }, (error) => {
                    console.error("Data fetch error:", error);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [user, db]);

            if (!firebaseReady || (loading && !user)) {
                return (
                    <div className="min-h-screen-ios w-full flex items-center justify-center bg-stone-50 text-rose-500">
                        <Loader2Icon size={48} className="animate-spin" />
                    </div>
                );
            }

            return (
                <div className="min-h-screen-ios w-full bg-stone-50 font-sans text-stone-900 overflow-x-hidden selection:bg-rose-100 flex flex-col">
                    {view === 'home' && <LandingPage photos={photos} setView={setView} />}
                    {view === 'upload' && <UploadPage setView={setView} user={user} db={db} />}
                    {view === 'gallery' && <GalleryPage photos={photos} setView={setView} />}
                    {view !== 'upload' && <Navigation setView={setView} view={view} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
